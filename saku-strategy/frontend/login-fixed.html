<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAKU Login - Fixed</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script src="api-config.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
        }
        
        body {
            margin: 0;
            padding: 20px;
            background: #f0fdf4;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 400px;
            width: 100%;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .logo-section {
            margin-bottom: 15px;
        }
        
        .logo-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .logo-text {
            font-size: 0.9em;
            font-weight: 600;
            letter-spacing: 1px;
            opacity: 0.95;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2em;
            font-weight: bold;
        }
        
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .form-container {
            padding: 40px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .required {
            color: #e74c3c;
        }
        
        input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            width: 100%;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
        }
        
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #10b981;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .info-box {
            background: #e8f4fd;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .info-box h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
        }
        
        .info-box p {
            margin: 0;
            color: #333;
            font-size: 0.9em;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
        }
        
        .footer a {
            color: #059669;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .remember-me input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
        }
        
        .remember-me label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        .test-credentials {
            background: #d1fae5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }
        
        .test-credentials h4 {
            margin: 0 0 10px 0;
            color: #047857;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .test-credentials p {
            margin: 5px 0;
            color: #065f46;
        }
        
        .user-type-selection {
            background: #d1fae5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .user-type-selection label {
            font-weight: 600;
            color: #047857;
            margin-bottom: 12px;
            display: block;
        }
        
        .user-type-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .user-type-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 2px solid #a7f3d0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .user-type-option:hover {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .user-type-option.selected {
            border-color: #059669;
            background: #d1fae5;
        }
        
        .user-type-option input[type="radio"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .user-type-option label {
            margin: 0;
            cursor: pointer;
            font-weight: 500;
            color: #065f46;
            flex: 1;
        }
        
        .user-type-instructions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #a7f3d0;
            font-size: 0.85em;
            color: #065f46;
        }
        
        .user-type-instructions p {
            margin: 5px 0;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .form-container {
                padding: 25px 20px;
            }
            
            input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .submit-btn {
                padding: 12px 30px;
                font-size: 16px;
            }
            
            .test-credentials {
                padding: 12px;
                font-size: 0.85em;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .form-container {
                padding: 20px 15px;
            }
            
            .footer {
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-section">
                <div class="logo-icon">☀️</div>
                <div class="logo-text">KCA UNIVERSITY</div>
            </div>
            <h1>SAKU Login</h1>
            <p>Access Your Portal</p>
        </div>
        
        <div class="form-container">
            <div class="test-credentials">
                <h4>✅ Test Credentials</h4>
                <p><strong>Student:</strong> test_student / test123</p>
                <p><strong>Admin:</strong> Saitoti / Saitoti2004</p>
                <p><strong>New User (20/03623):</strong> 20/03623 / test123</p>
            </div>
            
            <div class="user-type-selection">
                <label>I am a: <span class="required">*</span></label>
                <div class="user-type-options">
                    <div class="user-type-option" id="option-student">
                        <input type="radio" id="userTypeStudent" name="userType" value="STUDENT">
                        <label for="userTypeStudent">Student/Voter</label>
                    </div>
                    <div class="user-type-option" id="option-aspirant">
                        <input type="radio" id="userTypeAspirant" name="userType" value="ASPIRANT">
                        <label for="userTypeAspirant">Aspirant</label>
                    </div>
                    <div class="user-type-option selected" id="option-admin">
                        <input type="radio" id="userTypeAdmin" name="userType" value="ADMIN" checked>
                        <label for="userTypeAdmin">Admin</label>
                    </div>
                </div>
                <div class="user-type-instructions">
                    <p>Student/Voter: Use your registration number and password from email.</p>
                    <p>Aspirant/Admin: Use your registered credentials.</p>
                </div>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Username/Registration Number <span class="required">*</span></label>
                    <input type="text" id="username" name="username" required placeholder="Enter your username or registration number (e.g., 12/34567)" maxlength="9">
                </div>
                
                <div class="form-group">
                    <label for="password">Password <span class="required">*</span></label>
                    <input type="password" id="password" name="password" required placeholder="Enter your password">
                </div>
                
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" name="rememberMe">
                    <label for="rememberMe">Remember my login credentials</label>
                </div>
                
                <button type="submit" class="submit-btn" id="submitBtn">
                    Sign In
                </button>
            </form>
            
            <div class="footer">
                <p>Don't have an account? <a href="signup.html">Create Account</a></p>
                <p>© 2024 SAKU - Student's Association of KCA University</p>
            </div>
        </div>
    </div>

    <script>
        // Load saved credentials on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedCredentials();
            
            // Auto-insert slash after 2 digits in registration number field
            document.getElementById('username').addEventListener('input', function(e) {
                let value = this.value;
                // Auto-insert slash after 2 digits
                if (value.length === 2 && !value.includes('/')) {
                    value = value + '/';
                    this.value = value;
                }
            });
            
            // Handle user type selection highlighting
            const userTypeRadios = document.querySelectorAll('input[name="userType"]');
            userTypeRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    // Remove selected class from all options
                    document.querySelectorAll('.user-type-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    // Add selected class to the parent of the checked radio
                    if (this.checked) {
                        this.closest('.user-type-option').classList.add('selected');
                    }
                });
            });
            
            // Initialize selection state for the checked radio
            const checkedRadio = document.querySelector('input[name="userType"]:checked');
            if (checkedRadio) {
                checkedRadio.closest('.user-type-option').classList.add('selected');
            }
        });
        
        function loadSavedCredentials() {
            try {
                const savedCredentials = localStorage.getItem('saku_saved_credentials');
                if (savedCredentials) {
                    const credentials = JSON.parse(savedCredentials);
                    document.getElementById('username').value = credentials.username || '';
                    document.getElementById('password').value = credentials.password || '';
                    document.getElementById('rememberMe').checked = true;
                    console.log('✅ Credentials loaded from storage');
                }
            } catch (error) {
                console.error('❌ Error loading saved credentials:', error);
            }
        }
        
        function saveCredentials(username, password) {
            try {
                const credentials = {
                    username: username,
                    password: password,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('saku_saved_credentials', JSON.stringify(credentials));
                console.log('✅ Credentials saved to storage');
            } catch (error) {
                console.error('❌ Error saving credentials:', error);
            }
        }
        
        function clearSavedCredentials() {
            try {
                localStorage.removeItem('saku_saved_credentials');
                console.log('✅ Saved credentials cleared');
            } catch (error) {
                console.error('❌ Error clearing credentials:', error);
            }
        }
        
        // Form submission
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div>Authenticating...';
            
            try {
                console.log('Attempting login with:', { username, password: '***' });
                
                // Make API call to login endpoint
                const response = await fetch(window.API_CONFIG.url('api/auth/login/'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                console.log('Login response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Login error response:', errorData);
                    throw new Error(errorData.error || 'Login failed');
                }

                const data = await response.json();
                
                // Store tokens and user data
                localStorage.setItem('saku_tokens', JSON.stringify({
                    access: data.access,
                    refresh: data.refresh
                }));
                
                // Store profile with admin flag
                const profileWithAdmin = {
                    ...data.profile,
                    is_admin: data.is_admin
                };
                localStorage.setItem('saku_user_profile', JSON.stringify(profileWithAdmin));
                
                // Handle "Remember Me" functionality
                if (rememberMe) {
                    saveCredentials(username, password);
                } else {
                    clearSavedCredentials();
                }
                
                submitBtn.innerHTML = 'Login Successful!';
                submitBtn.style.background = '#28a745';
                
                // Show success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.innerHTML = `
                    <h4>Welcome Back, ${data.profile.full_name || data.profile.username}!</h4>
                    <p>You have been authenticated successfully. Redirecting...</p>
                `;
                
                document.querySelector('.form-container').insertBefore(successDiv, document.getElementById('loginForm'));
                
                // Redirect based on user type
                setTimeout(() => {
                    if (data.is_admin) {
                        window.location.href = 'admin-dashboard-enhanced.html';
                    } else {
                        // All students go to personal portal to review submissions and admin insights
                        window.location.href = 'personal-portal.html';
                    }
                }, 2000);
                
            } catch (error) {
                console.error('Login error:', error);
                
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `
                    <h4>Login Failed</h4>
                    <p>${error.message}</p>
                `;
                
                document.querySelector('.form-container').insertBefore(errorDiv, document.getElementById('loginForm'));
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Sign In';
            }
        });
        
        // No need to update links since we're using direct signup.html links
    </script>
</body>
</html>
